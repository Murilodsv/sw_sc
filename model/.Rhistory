colour = "black") +
geom_abline(slope = 1,
intercept = 0,
colour = "red",
linetype = 2) +
geom_smooth(method='lm') +
scale_x_continuous(limits=axis.lim) +
scale_y_continuous(limits=axis.lim) +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.sct
#--- time-course
tc.df = melt(opt.sim.res$sim.obs, id.vars = c("year","doy","das","dap","var"))
gg.opt.tc = ggplot(tc.df, aes(x = das, y = as.numeric(value), fill = var, colour = var)) +
geom_line(data = tc.df[tc.df$variable == "sim",]) +
geom_point(data = tc.df[tc.df$variable == "obs",],
shape = 21,
colour = "black",
size =2) +
scale_y_continuous(limits=axis.lim) +
ylab("Variables") + xlab("Time-Course") +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.tc
#--- pressure head
h.df = opt.sim.res$sim.results$soil
h.df = h.df[h.df$depth %in% c(-4.5,-14,-31.5,-62),]
ggplot(h.df, aes(y = phead, x = das)) +
geom_line() + facet_wrap(.~depth, scales = "free") +
scale_y_continuous(limits = c(-330,0)) + theme_bw()
#--- transpiration
et.df = opt.sim.res$sim.results$incr
et.df = melt(et.df[,c("das","Tact","Tpot")], id.vars = c("das"))
ggplot(et.df, aes(x = das, y = value, colour = variable)) +
geom_line() +
theme_bw()
#--- Stress
str.red.df = opt.sim.res$sim.results$stre
str.red.df = melt(str.red.df, id.vars = c("date","year","doy","das"))
str.v = c("Tredwet","Treddry","Tredsol","Tredfrs")
ggplot(str.red.df[str.red.df$variable %in% str.v,], aes(x = das, y = value, colour = variable)) +
geom_line() +
theme_bw() + facet_wrap(.~variable)
#--- Exploring results
get.obj.fun = F
#--- running with different set of parameters to force water stress
opt.sim.res = opt.swap.samuca(c(0,0))
#--- Scatter plot
axis.lim = c(min(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 - 0.1),
max(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 + 0.1))
gg.opt.sct = ggplot(opt.sim.res$sim.obs, aes(x = obs, y = sim, fill = var)) +
ylab("Simulated")+xlab("Observed")+
geom_point(size = 2,
shape = 21,
colour = "black") +
geom_abline(slope = 1,
intercept = 0,
colour = "red",
linetype = 2) +
geom_smooth(method='lm') +
scale_x_continuous(limits=axis.lim) +
scale_y_continuous(limits=axis.lim) +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.sct
#--- time-course
tc.df = melt(opt.sim.res$sim.obs, id.vars = c("year","doy","das","dap","var"))
gg.opt.tc = ggplot(tc.df, aes(x = das, y = as.numeric(value), fill = var, colour = var)) +
geom_line(data = tc.df[tc.df$variable == "sim",]) +
geom_point(data = tc.df[tc.df$variable == "obs",],
shape = 21,
colour = "black",
size =2) +
scale_y_continuous(limits=axis.lim) +
ylab("Variables") + xlab("Time-Course") +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.tc
#--- pressure head
h.df = opt.sim.res$sim.results$soil
h.df = h.df[h.df$depth %in% c(-4.5,-14,-31.5,-62),]
ggplot(h.df, aes(y = phead, x = das)) +
geom_line() + facet_wrap(.~depth, scales = "free") +
scale_y_continuous(limits = c(-330,0)) + theme_bw()
#--- transpiration
et.df = opt.sim.res$sim.results$incr
et.df = melt(et.df[,c("das","Tact","Tpot")], id.vars = c("das"))
ggplot(et.df, aes(x = das, y = value, colour = variable)) +
geom_line() +
theme_bw()
#--- Stress
str.red.df = opt.sim.res$sim.results$stre
str.red.df = melt(str.red.df, id.vars = c("date","year","doy","das"))
str.v = c("Tredwet","Treddry","Tredsol","Tredfrs")
ggplot(str.red.df[str.red.df$variable %in% str.v,], aes(x = das, y = value, colour = variable)) +
geom_line() +
theme_bw() + facet_wrap(.~variable)
new.par = c(0,0)
#--- Read iteration control
opt.df  = read.csv(opt.df.fn, as.is = T)
it      = opt.df$it[length(opt.df$it)]
ini.run = opt.df$ini.run[length(opt.df$it)]
if(!ini.run){
last.objective.fun = opt.df$objective[length(opt.df$it)]
}
#--------------------------------#
#--- Update set of parameters ---#
#--------------------------------#
#--- Unscaled parameters
p.df$value = p.df$min + new.par * (p.df$max - p.df$min)
if(ini.run){
#--- Initializa log file
w.log(log.file = log.file,
ini.log = T)
w.log(w.msg = paste0("Running ",sim.id),log.file = log.file,
h.msg = F)
}
#--- Check parameters
valid.par.cond = check.cond(p.df)
valid.par.rang = check.rang(p.df)
#--- Update control files
l.par.files = unique(p.df$file)
l.par.files
for(f in l.par.files){}
#--- open and replace new parameter values
rep.par = read.csv(f,as.is = T)
rep.par
as.character(p.df$value[p.df$find %in% p.df$find[p.df$file == f]])
p.df$value
new.par
p.df$min
p.df$max
p.df$min
p.df$value
#--- Get paths
get.rp.root = function(){
r.wd = dirname(rstudioapi::getSourceEditorContext()$path)
git.not.found = T
l.f = strsplit(r.wd,"/")[[1]]
i.path = length(l.f)
while(git.not.found){
wd = paste(l.f[1:i.path], collapse = "/")
if(length(list.files(wd, all.files = T,pattern = ".git")) > 0){
git.not.found = F
return(wd)
}else{
if(i.path == 1){
git.not.found = F
message("No Git File Found in Path Tree:")
message(r.wd)
return(r.wd)
}else{
i.path = i.path - 1
}
}
}
}
wd.repo   = get.rp.root()
wd.rsam   = paste0(wd.repo,"/R/R_samuca")
wd.lib    = paste0(wd.repo,"/R/R_samuca/lib")
wd.model  = paste0(wd.repo,"/model")
wd.debug  = paste0(wd.repo,"/Debug")
#--- Load Source Files (~/bin)
invisible(sapply(list.files(path = wd.lib,full.names = T),
function(x) source(x)))
#--- running with different set of parameters to force water stress
opt.sim.res = opt.swap.samuca(c(0,0))
#--- Exploring results
get.obj.fun = F
#--- running with different set of parameters to force water stress
opt.sim.res = opt.swap.samuca(c(0,0))
#--- Scatter plot
axis.lim = c(min(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 - 0.1),
max(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 + 0.1))
gg.opt.sct = ggplot(opt.sim.res$sim.obs, aes(x = obs, y = sim, fill = var)) +
ylab("Simulated")+xlab("Observed")+
geom_point(size = 2,
shape = 21,
colour = "black") +
geom_abline(slope = 1,
intercept = 0,
colour = "red",
linetype = 2) +
geom_smooth(method='lm') +
scale_x_continuous(limits=axis.lim) +
scale_y_continuous(limits=axis.lim) +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.sct
#--- time-course
tc.df = melt(opt.sim.res$sim.obs, id.vars = c("year","doy","das","dap","var"))
gg.opt.tc = ggplot(tc.df, aes(x = das, y = as.numeric(value), fill = var, colour = var)) +
geom_line(data = tc.df[tc.df$variable == "sim",]) +
geom_point(data = tc.df[tc.df$variable == "obs",],
shape = 21,
colour = "black",
size =2) +
scale_y_continuous(limits=axis.lim) +
ylab("Variables") + xlab("Time-Course") +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.tc
#--- pressure head
h.df = opt.sim.res$sim.results$soil
h.df = h.df[h.df$depth %in% c(-4.5,-14,-31.5,-62),]
ggplot(h.df, aes(y = phead, x = das)) +
geom_line() + facet_wrap(.~depth, scales = "free") +
scale_y_continuous(limits = c(-330,0)) + theme_bw()
#--- transpiration
et.df = opt.sim.res$sim.results$incr
et.df = melt(et.df[,c("das","Tact","Tpot")], id.vars = c("das"))
ggplot(et.df, aes(x = das, y = value, colour = variable)) +
geom_line() +
theme_bw()
#--- Stress
str.red.df = opt.sim.res$sim.results$stre
str.red.df = melt(str.red.df, id.vars = c("date","year","doy","das"))
str.v = c("Tredwet","Treddry","Tredsol","Tredfrs")
ggplot(str.red.df[str.red.df$variable %in% str.v,], aes(x = das, y = value, colour = variable)) +
geom_line() +
theme_bw() + facet_wrap(.~variable)
p.df.opt        = read.csv(paste0(wd.rsam,"/opt/par_df.csv"), as.is = T)
#--- Only parameters set to for optimization
p.df = p.df.opt[p.df.opt$opt,]
#--- Exploring results
get.obj.fun = F
#--- running with different set of parameters to force water stress
opt.sim.res = opt.swap.samuca(c(0,0))
#--- Scatter plot
axis.lim = c(min(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 - 0.1),
max(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 + 0.1))
gg.opt.sct = ggplot(opt.sim.res$sim.obs, aes(x = obs, y = sim, fill = var)) +
ylab("Simulated")+xlab("Observed")+
geom_point(size = 2,
shape = 21,
colour = "black") +
geom_abline(slope = 1,
intercept = 0,
colour = "red",
linetype = 2) +
geom_smooth(method='lm') +
scale_x_continuous(limits=axis.lim) +
scale_y_continuous(limits=axis.lim) +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.sct
#--- time-course
tc.df = melt(opt.sim.res$sim.obs, id.vars = c("year","doy","das","dap","var"))
gg.opt.tc = ggplot(tc.df, aes(x = das, y = as.numeric(value), fill = var, colour = var)) +
geom_line(data = tc.df[tc.df$variable == "sim",]) +
geom_point(data = tc.df[tc.df$variable == "obs",],
shape = 21,
colour = "black",
size =2) +
scale_y_continuous(limits=axis.lim) +
ylab("Variables") + xlab("Time-Course") +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.tc
#--- pressure head
h.df = opt.sim.res$sim.results$soil
h.df = h.df[h.df$depth %in% c(-4.5,-14,-31.5,-62),]
ggplot(h.df, aes(y = phead, x = das)) +
geom_line() + facet_wrap(.~depth, scales = "free") +
scale_y_continuous(limits = c(-330,0)) + theme_bw()
#--- transpiration
et.df = opt.sim.res$sim.results$incr
et.df = melt(et.df[,c("das","Tact","Tpot")], id.vars = c("das"))
ggplot(et.df, aes(x = das, y = value, colour = variable)) +
geom_line() +
theme_bw()
#--- Stress
str.red.df = opt.sim.res$sim.results$stre
str.red.df = melt(str.red.df, id.vars = c("date","year","doy","das"))
str.v = c("Tredwet","Treddry","Tredsol","Tredfrs")
ggplot(str.red.df[str.red.df$variable %in% str.v,], aes(x = das, y = value, colour = variable)) +
geom_line() +
theme_bw() + facet_wrap(.~variable)
p.df.opt        = read.csv(paste0(wd.rsam,"/opt/par_df.csv"), as.is = T)
#--- Only parameters set to for optimization
p.df = p.df.opt[p.df.opt$opt,]
get.obj.fun = F
#--- running with different set of parameters to force water stress
opt.sim.res = opt.swap.samuca(c(0,0))
#--- Scatter plot
axis.lim = c(min(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 - 0.1),
max(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 + 0.1))
gg.opt.sct = ggplot(opt.sim.res$sim.obs, aes(x = obs, y = sim, fill = var)) +
ylab("Simulated")+xlab("Observed")+
geom_point(size = 2,
shape = 21,
colour = "black") +
geom_abline(slope = 1,
intercept = 0,
colour = "red",
linetype = 2) +
geom_smooth(method='lm') +
scale_x_continuous(limits=axis.lim) +
scale_y_continuous(limits=axis.lim) +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.sct
#--- time-course
tc.df = melt(opt.sim.res$sim.obs, id.vars = c("year","doy","das","dap","var"))
gg.opt.tc = ggplot(tc.df, aes(x = das, y = as.numeric(value), fill = var, colour = var)) +
geom_line(data = tc.df[tc.df$variable == "sim",]) +
geom_point(data = tc.df[tc.df$variable == "obs",],
shape = 21,
colour = "black",
size =2) +
scale_y_continuous(limits=axis.lim) +
ylab("Variables") + xlab("Time-Course") +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.tc
#--- pressure head
h.df = opt.sim.res$sim.results$soil
h.df = h.df[h.df$depth %in% c(-4.5,-14,-31.5,-62),]
ggplot(h.df, aes(y = phead, x = das)) +
geom_line() + facet_wrap(.~depth, scales = "free") +
scale_y_continuous(limits = c(-330,0)) + theme_bw()
#--- transpiration
et.df = opt.sim.res$sim.results$incr
et.df = melt(et.df[,c("das","Tact","Tpot")], id.vars = c("das"))
ggplot(et.df, aes(x = das, y = value, colour = variable)) +
geom_line() +
theme_bw()
#--- Stress
str.red.df = opt.sim.res$sim.results$stre
str.red.df = melt(str.red.df, id.vars = c("date","year","doy","das"))
str.v = c("Tredwet","Treddry","Tredsol","Tredfrs")
ggplot(str.red.df[str.red.df$variable %in% str.v,], aes(x = das, y = value, colour = variable)) +
geom_line() +
theme_bw() + facet_wrap(.~variable)
ggplot(h.df, aes(y = phead, x = das)) +
geom_line() + facet_wrap(.~depth, scales = "free") +
scale_y_continuous(limits = c(-330,0)) + theme_bw()
ggplot(h.df, aes(y = phead, x = das)) +
geom_line() + facet_wrap(.~depth, scales = "free") +
scale_y_continuous() + theme_bw()
#--- pressure head
h.df = opt.sim.res$sim.results$soil
h.df = h.df[h.df$depth %in% c(-4.5,-14,-31.5,-62),]
h.df
#--- pressure head
h.df = opt.sim.res$sim.results$soil
unique(h.df$depth)
#--- pressure head
h.df = opt.sim.res$sim.results$soil
h.df = h.df[h.df$depth %in% c(-4.5,-14,-31.5,-61.5),]
ggplot(h.df, aes(y = phead, x = das)) +
geom_line() + facet_wrap(.~depth, scales = "free") +
scale_y_continuous() + theme_bw()
get.obj.fun = F
#--- running with different set of parameters to force water stress
opt.sim.res = opt.swap.samuca(c(0,0))
#--- Scatter plot
axis.lim = c(min(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 - 0.1),
max(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 + 0.1))
gg.opt.sct = ggplot(opt.sim.res$sim.obs, aes(x = obs, y = sim, fill = var)) +
ylab("Simulated")+xlab("Observed")+
geom_point(size = 2,
shape = 21,
colour = "black") +
geom_abline(slope = 1,
intercept = 0,
colour = "red",
linetype = 2) +
geom_smooth(method='lm') +
scale_x_continuous(limits=axis.lim) +
scale_y_continuous(limits=axis.lim) +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.sct
#--- time-course
tc.df = melt(opt.sim.res$sim.obs, id.vars = c("year","doy","das","dap","var"))
gg.opt.tc = ggplot(tc.df, aes(x = das, y = as.numeric(value), fill = var, colour = var)) +
geom_line(data = tc.df[tc.df$variable == "sim",]) +
geom_point(data = tc.df[tc.df$variable == "obs",],
shape = 21,
colour = "black",
size =2) +
scale_y_continuous(limits=axis.lim) +
ylab("Variables") + xlab("Time-Course") +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.tc
#--- pressure head
h.df = opt.sim.res$sim.results$soil
h.df = h.df[h.df$depth %in% c(-4.5,-14,-31.5,-61.5),]
ggplot(h.df, aes(y = phead, x = das)) +
geom_line() + facet_wrap(.~depth, scales = "free") +
scale_y_continuous() + theme_bw()
get.obj.fun = F
#--- running with different set of parameters to force water stress
opt.sim.res = opt.swap.samuca(c(0,0))
#--- Scatter plot
axis.lim = c(min(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 - 0.1),
max(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 + 0.1))
gg.opt.sct = ggplot(opt.sim.res$sim.obs, aes(x = obs, y = sim, fill = var)) +
ylab("Simulated")+xlab("Observed")+
geom_point(size = 2,
shape = 21,
colour = "black") +
geom_abline(slope = 1,
intercept = 0,
colour = "red",
linetype = 2) +
geom_smooth(method='lm') +
scale_x_continuous(limits=axis.lim) +
scale_y_continuous(limits=axis.lim) +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.sct
#--- time-course
tc.df = melt(opt.sim.res$sim.obs, id.vars = c("year","doy","das","dap","var"))
gg.opt.tc = ggplot(tc.df, aes(x = das, y = as.numeric(value), fill = var, colour = var)) +
geom_line(data = tc.df[tc.df$variable == "sim",]) +
geom_point(data = tc.df[tc.df$variable == "obs",],
shape = 21,
colour = "black",
size =2) +
scale_y_continuous(limits=axis.lim) +
ylab("Variables") + xlab("Time-Course") +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.tc
#--- pressure head
h.df = opt.sim.res$sim.results$soil
h.df = h.df[h.df$depth %in% c(-4.5,-14,-31.5,-61.5),]
ggplot(h.df, aes(y = phead, x = das)) +
geom_line() + facet_wrap(.~depth, scales = "free") +
scale_y_continuous() + theme_bw()
#--- transpiration
et.df = opt.sim.res$sim.results$incr
et.df = melt(et.df[,c("das","Tact","Tpot")], id.vars = c("das"))
ggplot(et.df, aes(x = das, y = value, colour = variable)) +
geom_line() +
theme_bw()
ggplot(str.red.df[str.red.df$variable %in% str.v,], aes(x = das, y = value, colour = variable)) +
geom_line() +
theme_bw() + facet_wrap(.~variable)
str.red.df[str.red.df$variable == "Treddry",]
str.red.df[str.red.df$variable == "Treddry",][1:2,]
str.red.df[str.red.df$variable == "Treddry",][450:500,]
ggplot(h.df, aes(y = phead, x = das)) +
geom_line() + facet_wrap(.~depth, scales = "free") +
scale_y_continuous() + theme_bw()
#--- running with different set of parameters to force water stress
opt.sim.res = opt.swap.samuca(c(0,0))
#--- Scatter plot
axis.lim = c(min(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 - 0.1),
max(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 + 0.1))
gg.opt.sct = ggplot(opt.sim.res$sim.obs, aes(x = obs, y = sim, fill = var)) +
ylab("Simulated")+xlab("Observed")+
geom_point(size = 2,
shape = 21,
colour = "black") +
geom_abline(slope = 1,
intercept = 0,
colour = "red",
linetype = 2) +
geom_smooth(method='lm') +
scale_x_continuous(limits=axis.lim) +
scale_y_continuous(limits=axis.lim) +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.sct
#--- time-course
tc.df = melt(opt.sim.res$sim.obs, id.vars = c("year","doy","das","dap","var"))
gg.opt.tc = ggplot(tc.df, aes(x = das, y = as.numeric(value), fill = var, colour = var)) +
geom_line(data = tc.df[tc.df$variable == "sim",]) +
geom_point(data = tc.df[tc.df$variable == "obs",],
shape = 21,
colour = "black",
size =2) +
scale_y_continuous(limits=axis.lim) +
ylab("Variables") + xlab("Time-Course") +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.tc
#--- pressure head
h.df = opt.sim.res$sim.results$soil
h.df
h.df = h.df[h.df$depth %in% c(-7.5,-20,-40,-67.5),]
ggplot(h.df, aes(y = phead, x = das)) +
geom_line() + facet_wrap(.~depth, scales = "free") +
scale_y_continuous() + theme_bw()
#--- running with different set of parameters to force water stress
opt.sim.res = opt.swap.samuca(c(0,0))
#--- Scatter plot
axis.lim = c(min(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 - 0.1),
max(opt.sim.res$sim.obs$obs,opt.sim.res$sim.obs$sim) * (1 + 0.1))
gg.opt.sct = ggplot(opt.sim.res$sim.obs, aes(x = obs, y = sim, fill = var)) +
ylab("Simulated")+xlab("Observed")+
geom_point(size = 2,
shape = 21,
colour = "black") +
geom_abline(slope = 1,
intercept = 0,
colour = "red",
linetype = 2) +
geom_smooth(method='lm') +
scale_x_continuous(limits=axis.lim) +
scale_y_continuous(limits=axis.lim) +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.sct
#--- time-course
tc.df = melt(opt.sim.res$sim.obs, id.vars = c("year","doy","das","dap","var"))
gg.opt.tc = ggplot(tc.df, aes(x = das, y = as.numeric(value), fill = var, colour = var)) +
geom_line(data = tc.df[tc.df$variable == "sim",]) +
geom_point(data = tc.df[tc.df$variable == "obs",],
shape = 21,
colour = "black",
size =2) +
scale_y_continuous(limits=axis.lim) +
ylab("Variables") + xlab("Time-Course") +
theme_bw() + facet_wrap(.~var, scales = "free")
gg.opt.tc
#--- pressure head
h.df = opt.sim.res$sim.results$soil
unique(h.df$depth)
#--- pressure head
h.df = opt.sim.res$sim.results$soil
h.df = h.df[h.df$depth %in% c(-5,-15,-30,-60),]
ggplot(h.df, aes(y = phead, x = das)) +
geom_line() + facet_wrap(.~depth, scales = "free") +
scale_y_continuous() + theme_bw()
